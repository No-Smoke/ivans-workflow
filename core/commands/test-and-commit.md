# Generated by Ivan's Workflow — https://github.com/No-Smoke/ivans-workflow

# /test-and-commit — Run quality gates, commit on success

Run the project's configured quality checks (typecheck, lint, test) in sequence. If ALL pass, stage changes and create a conventional commit. If ANY fail, report the failures and do NOT commit.

## Steps

1. Read quality commands from `.claude/project-config.yaml`:
   - `quality.typecheck_command` (skip if empty)
   - `quality.lint_command` (skip if empty)
   - `quality.test_command` (required)

2. Run each in order, capture output:
   ```
   [1/3] Typecheck... ✓ passed (2.1s)
   [2/3] Lint... ✓ passed (1.4s)
   [3/3] Tests... ✓ 47 passed, 0 failed (8.3s)
   ```

3. If ALL pass:
   - Run `git add -A` (or stage only relevant files if specified)
   - Prompt for or generate a conventional commit message:
     - Format: `type(scope): description`
     - Types: feat, fix, refactor, test, docs, chore, perf
   - Run `git commit -m "message"`
   - Print: "✓ Committed: {short hash} {message}"

4. If ANY fail:
   - Print which step failed with first 30 lines of error output
   - Print: "✗ Commit blocked — fix failures above"
   - Do NOT stage or commit anything

## Conventional Commit Inference

If no message is provided, infer from the diff:
- New files in `src/` → `feat`
- Modified test files → `test`
- Modified docs → `docs`
- Bug fix patterns (fix, patch, correct) → `fix`
- Scope from the primary directory changed
