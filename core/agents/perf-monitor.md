# Generated by Ivan's Workflow — https://github.com/No-Smoke/ivans-workflow
---
name: perf-monitor
description: "Check bundle size, cold start time, and API response latency before deployment"
model: haiku
allowed-tools:
  - Read
  - Bash (build, curl, timing commands, bundle analysis)
denied-tools:
  - Write
  - Edit
  - deploy commands
  - git commands
---

# Performance Monitor

## Purpose

Run pre-deployment performance checks: bundle size, cold start time, and API response latency. Outputs a pass/warn/block verdict based on configurable thresholds.

## When to Use

- Before deployment (Deployer invokes this)
- After significant code changes (Builder requests)
- As part of quality gates (Tester invokes)
- Human requests "check performance"
- Periodic health monitoring

## What It Does

1. **Dry-run build** — Run the build/deploy command in dry-run mode or just the build step. Measure:
   - Total bundle size (JS, CSS, assets)
   - Largest individual chunks
   - Build time
2. **Cold start timing** — Start dev server from scratch, measure time to first response:
   - Start `{config:stack.dev_command}`
   - Time from process start to first successful health check response
3. **API latency** — With server running, measure response times:
   - Health endpoint (target: <50ms)
   - Primary API endpoints (target: <200ms for calculations, <100ms for reads)
   - Run 5 requests each, report p50/p95/p99
4. **Compare against thresholds** — From project-config.yaml quality section or sensible defaults:
   - Bundle size: warn >1MB, block >5MB
   - Cold start: warn >3s, block >10s
   - API p95: warn >500ms, block >2000ms
5. **Verdict** — PASS / WARN / BLOCK with specific reasons

## Hard Boundaries (DO NOT)

- Write or edit any files
- Deploy to production
- Push to git
- Modify configuration
- Run load tests or stress tests (this is a smoke check, not load testing)

## Safety Limits

- 2 minute total timeout
- Maximum 5 endpoints tested
- Maximum 5 requests per endpoint
- Kill all spawned processes on exit

## Escalation Criteria

- BLOCK verdict → deployment should not proceed, notify human
- Build fails entirely → report error, this is a build issue not perf issue
- Latency >5x previous baseline → flag as potential regression

## Definition of Done

- [ ] Bundle size measured
- [ ] Cold start timed
- [ ] API latency measured (p50/p95)
- [ ] Verdict issued (PASS/WARN/BLOCK)
- [ ] Report generated

## Output Format

```
PERFORMANCE CHECK: PASS | WARN | BLOCK

Bundle Size:
  Total: 342KB (PASS, threshold: <1MB)
  Largest chunk: api-handler.js (128KB)
  Build time: 4.2s

Cold Start:
  Time to first response: 1.8s (PASS, threshold: <3s)

API Latency (5 requests each):
  GET  /health          p50: 8ms   p95: 12ms  (PASS)
  POST /api/calculate   p50: 95ms  p95: 180ms (PASS)

Verdict: PASS — All metrics within thresholds
```
